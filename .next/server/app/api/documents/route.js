"use strict";(()=>{var e={};e.id=395,e.ids=[395],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57147:e=>{e.exports=require("fs")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},71017:e=>{e.exports=require("path")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},71267:e=>{e.exports=require("worker_threads")},59796:e=>{e.exports=require("zlib")},30478:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>I,requestAsyncStorage:()=>j,routeModule:()=>q,serverHooks:()=>$,staticGenerationAsyncStorage:()=>D});var s={};r.r(s),r.d(s,{DELETE:()=>R,GET:()=>E,POST:()=>b,maxDuration:()=>_});var n=r(49303),o=r(88716),a=r(60670),i=r(87070),u=r(65655),c=r(92992),d=r(6005),l=r.n(d);let m={randomUUID:l().randomUUID},p=new Uint8Array(256),f=p.length,g=[];for(let e=0;e<256;++e)g.push((e+256).toString(16).slice(1));let h=function(e,t,r){if(m.randomUUID&&!t&&!e)return m.randomUUID();let s=(e=e||{}).random||(e.rng||function(){return f>p.length-16&&(l().randomFillSync(p),f=0),p.slice(f,f+=16)})();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=s[e];return t}return function(e,t=0){return(g[e[t+0]]+g[e[t+1]]+g[e[t+2]]+g[e[t+3]]+"-"+g[e[t+4]]+g[e[t+5]]+"-"+g[e[t+6]]+g[e[t+7]]+"-"+g[e[t+8]]+g[e[t+9]]+"-"+g[e[t+10]]+g[e[t+11]]+g[e[t+12]]+g[e[t+13]]+g[e[t+14]]+g[e[t+15]]).toLowerCase()}(s)};async function w(e,t){try{let r=await (0,u.R)(),s="application/pdf"===e.type||e.name.toLowerCase().endsWith(".pdf"),n=h(),o=`documents/${t}/${n}/${e.name}`,{error:a}=await r.storage.from("sbwc-documents").upload(o,e);if(a)throw Error(`File upload failed: ${a.message}`);if(s){let s={id:n,name:e.name,storage_path:o,file_size_bytes:e.size,metadata:{processing_status:"pending",file_type:"pdf"}};"00000000-0000-0000-0000-000000000001"!==t&&(s.created_by=t);let{data:a,error:i}=await r.from("sbwc_documents").insert(s).select().single();if(i)throw await r.storage.from("sbwc-documents").remove([o]),Error(`Document insert failed: ${i.message}`);return{id:n,name:e.name,storage_path:o,sections_count:0,uploaded_at:a.created_at,processing_status:"pending"}}let i=await x(e);if(!i||0===i.trim().length)throw Error("No text content found in file");let d=function(e){let t=[],r=e.split(/\n\s*\n/).map(e=>e.trim()).filter(e=>e.length>0),s=[],n=0,o=null;for(let e of r){e.startsWith("#")&&(o=e.replace(/^#+\s*/,"").trim());let r=(0,c.VI)(e);if(n+r>512&&s.length>0){let a=s.join("\n\n"),i=(0,c.VI)(a);i>=50&&t.push({content:a,heading:o,tokenCount:i});let u=s[s.length-1];s=[u,e],n=(0,c.VI)(u)+r}else s.push(e),n+=r}if(s.length>0){let e=s.join("\n\n"),r=(0,c.VI)(e);r>=50&&t.push({content:e,heading:o,tokenCount:r})}return t}(i);if(0===d.length)throw Error("Failed to create text chunks");let l=await (0,c.nj)(d.map(e=>e.content)),m={id:n,name:e.name,storage_path:o,file_size_bytes:e.size,metadata:{processing_status:"completed",file_type:"text"}};"00000000-0000-0000-0000-000000000001"!==t&&(m.created_by=t);let{data:p,error:f}=await r.from("sbwc_documents").insert(m).select().single();if(f)throw await r.storage.from("sbwc-documents").remove([o]),Error(`Document insert failed: ${f.message}`);let g=d.map((e,t)=>({document_id:n,content:e.content,heading:e.heading,embedding:l[t],token_count:e.tokenCount})),{error:w}=await r.from("sbwc_document_sections").insert(g);if(w)throw await r.from("sbwc_documents").delete().eq("id",n),await r.storage.from("sbwc-documents").remove([o]),Error(`Sections insert failed: ${w.message}`);return{id:n,name:e.name,storage_path:o,sections_count:d.length,uploaded_at:p.created_at,processing_status:"completed"}}catch(e){throw console.error("Error processing document:",e),Error(`Document processing failed: ${e instanceof Error?e.message:String(e)}`)}}async function x(e){let t=e.type,r=e.name.toLowerCase();if("text/plain"===t||r.endsWith(".txt"))return await e.text();throw Error(`Unsupported file type for inline processing: ${t||"unknown"}. Only .txt files can be processed immediately.`)}async function y(e,t){try{let r=await (0,u.R)(),{data:s,error:n}=await r.from("sbwc_documents").select("storage_path, created_by").eq("id",e).single();if(n||!s)throw Error("Document not found");if(s.created_by&&s.created_by!==t&&"00000000-0000-0000-0000-000000000001"!==t)throw Error("Unauthorized: You do not own this document");let{error:o}=await r.storage.from("sbwc-documents").remove([s.storage_path]);o&&console.error("Storage deletion error:",o);let{error:a}=await r.from("sbwc_documents").delete().eq("id",e);if(a)throw Error(`Document deletion failed: ${a.message}`)}catch(e){throw console.error("Error deleting document:",e),Error(`Failed to delete document: ${e instanceof Error?e.message:String(e)}`)}}let _=30;async function E(){try{let e=await (0,u.R)(),{data:t,error:r}=await e.from("sbwc_documents").select("id, name, storage_path, file_size_bytes, metadata, created_at, updated_at").order("created_at",{ascending:!1});if(r)return console.error("Error fetching documents:",r),i.NextResponse.json({status:"error",message:"Failed to fetch documents",documents:[],count:0},{status:500});return i.NextResponse.json({status:"success",documents:t||[],count:t?.length||0},{status:200})}catch(e){return console.error("Documents GET error:",e),i.NextResponse.json({status:"error",message:e instanceof Error?e.message:"Unknown error",documents:[],count:0},{status:500})}}async function b(e){try{let t=(await e.formData()).get("file");if(!t)return i.NextResponse.json({status:"error",message:'No file provided. Include a file in the "file" field.'},{status:400});if(0===t.size)return i.NextResponse.json({status:"error",message:"File is empty"},{status:400});if(t.size>10485760)return i.NextResponse.json({status:"error",message:"File too large. Maximum size: 10MB"},{status:400});let r=t.name.toLowerCase();if(!(["text/plain","application/pdf"].includes(t.type)||[".txt",".pdf"].some(e=>r.endsWith(e))))return i.NextResponse.json({status:"error",message:"Unsupported file type. Supported types: .txt, .pdf"},{status:400});let s=await w(t,"00000000-0000-0000-0000-000000000001");return i.NextResponse.json({status:"success",message:"Document uploaded successfully",document:s},{status:201})}catch(e){return console.error("Document upload error:",e),i.NextResponse.json({status:"error",message:e instanceof Error?e.message:"Upload failed"},{status:500})}}async function R(e){try{let{searchParams:t}=new URL(e.url),r=t.get("id");if(!r)return i.NextResponse.json({status:"error",message:"Document ID required"},{status:400});return await y(r,"00000000-0000-0000-0000-000000000001"),i.NextResponse.json({status:"success",message:"Document deleted successfully"},{status:200})}catch(r){console.error("Document deletion error:",r);let e=r instanceof Error?r.message:"Deletion failed",t=e.includes("Unauthorized")?403:500;return i.NextResponse.json({status:"error",message:e},{status:t})}}let q=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/documents/route",pathname:"/api/documents",filename:"route",bundlePath:"app/api/documents/route"},resolvedPagePath:"/home/jgatlit/projects/BourneLaw/SBWC-chatbot/pinecone-assistant/src/app/api/documents/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:j,staticGenerationAsyncStorage:D,serverHooks:$}=q,v="/api/documents/route";function I(){return(0,a.patchFetch)({serverHooks:$,staticGenerationAsyncStorage:D})}},92992:(e,t,r)=>{r.d(t,{C6:()=>i,VI:()=>c,nj:()=>u});var s=r(54214);let n=null;function o(){if(!n){let e=process.env.OPENAI_API_KEY;if(!e)throw Error("Missing OPENAI_API_KEY environment variable");n=new s.ZP({apiKey:e})}return n}let a={model:"text-embedding-3-large",dimensions:1536,maxRetries:3,retryDelayMs:1e3};async function i(e){let t=e.trim();if(!t)throw Error("Cannot generate embedding for empty text");let r=o(),s=null;for(let e=1;e<=a.maxRetries;e++)try{let e=await r.embeddings.create({model:a.model,input:t,dimensions:a.dimensions}),s=e.data[0]?.embedding;if(!s)throw Error("No embedding returned from OpenAI API");if(s.length!==a.dimensions)throw Error(`Expected ${a.dimensions} dimensions, got ${s.length}`);return s}catch(t){if((s=t instanceof Error?t:Error(String(t))).message.includes("empty text")||s.message.includes("dimensions"))throw s;if(e<a.maxRetries){let t=a.retryDelayMs*Math.pow(2,e-1);console.warn(`Embedding generation failed (attempt ${e}/${a.maxRetries}), retrying in ${t}ms...`,s.message),await new Promise(e=>setTimeout(e,t))}}throw Error(`Failed to generate embedding after ${a.maxRetries} attempts: ${s?.message}`)}async function u(e,t=100){if(0===e.length)return[];let r=[],s=o();for(let n=0;n<e.length;n+=t){let o=e.slice(n,n+t),i=null;for(let e=1;e<=a.maxRetries;e++)try{let e=(await s.embeddings.create({model:a.model,input:o,dimensions:a.dimensions})).data.sort((e,t)=>e.index-t.index).map(e=>e.embedding);r.push(...e);break}catch(t){if(i=t instanceof Error?t:Error(String(t)),e<a.maxRetries){let t=a.retryDelayMs*Math.pow(2,e-1);console.warn(`Batch embedding generation failed (attempt ${e}/${a.maxRetries}), retrying in ${t}ms...`,i.message),await new Promise(e=>setTimeout(e,t))}else throw Error(`Failed to generate batch embeddings after ${a.maxRetries} attempts: ${i.message}`)}}return r}function c(e){return Math.ceil(e.length/4)}},65655:(e,t,r)=>{r.d(t,{R:()=>n});var s=r(43974);async function n(){let e="https://sb.aichemist.agency",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t)throw Error("Missing Supabase environment variables (URL or SERVICE_ROLE_KEY)");return(0,s.eI)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}})}r(71615)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,972,326,518,214],()=>r(30478));module.exports=s})();